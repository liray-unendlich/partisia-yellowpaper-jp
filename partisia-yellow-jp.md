# Partisia Blockchain Yellow Paper(JP)

はじめましてこんばんはこんにちは。
技術情報をカバーするイエローペーパーを翻訳した（多分）ので、共有します。
頑張ったな～こいつと思ったら、お金ください。
また、少し妙に長いところがあったりするので、そういったところは適当に省いています。あらかじめご承知おきください。

- [Partisia Blockchain Yellow Paper(JP)](#partisia-blockchain-yellow-paperjp)
  - [導入](#導入)
  - [技術・エコノミーの概略](#技術エコノミーの概略)
    - [全体の構造](#全体の構造)
    - [アカウントの作成](#アカウントの作成)
    - [ノード運営者](#ノード運営者)
      - [ノード運営者の審査](#ノード運営者の審査)
      - [ノード運営者の選択方法](#ノード運営者の選択方法)
    - [スマートコントラクト](#スマートコントラクト)
      - [パブリックスマートコントラクト](#パブリックスマートコントラクト)
      - [プライベートスマートコントラクト](#プライベートスマートコントラクト)
      - [システムスマートコントラクト](#システムスマートコントラクト)
    - [ブロックチェーンの利用に対する費用の決定、支払い方法](#ブロックチェーンの利用に対する費用の決定支払い方法)
      - [価格決定、支払い方法](#価格決定支払い方法)
      - [スマートコントラクトの支払いメカニズム](#スマートコントラクトの支払いメカニズム)
    - [取引所リスク](#取引所リスク)
    - [ステーキング](#ステーキング)
      - [ベイカーノードのステーキング](#ベイカーノードのステーキング)
      - [ZKノードのステーキング](#zkノードのステーキング)
      - [オラクルノードのステーキング](#オラクルノードのステーキング)
    - [デリゲーション（共同ステーキング）](#デリゲーション共同ステーキング)
    - [スコアリング](#スコアリング)
    - [ソフトウェアの更新](#ソフトウェアの更新)
  - [L1ブロックチェーンサービス](#l1ブロックチェーンサービス)
    - [コンセンサスとブロック生成](#コンセンサスとブロック生成)
      - [Proof of Verification](#proof-of-verification)
      - [FastTrack consensus](#fasttrack-consensus)
    - [Sharding](#sharding)
    - [L1ブロックチェーンサービスの支払いスキーム](#l1ブロックチェーンサービスの支払いスキーム)
  - [Zero Knowledge 計算](#zero-knowledge-計算)
    - [プライベートスマートコントラクトの概要](#プライベートスマートコントラクトの概要)
    - [MPCオーケストレーション](#mpcオーケストレーション)
    - [前処理(Pre processing)](#前処理pre-processing)
    - [支払いスキーム](#支払いスキーム)
    - [スコアリング](#スコアリング-1)
    - [ステーキング](#ステーキング-1)
  - [オラクルサービス](#オラクルサービス)
    - [クロスチェーンセキュリティモデル](#クロスチェーンセキュリティモデル)
    - [Bring Your Own Coin (BYOC)](#bring-your-own-coin-byoc)
      - [ステーキング](#ステーキング-2)
    - [トークンブリッジ](#トークンブリッジ)
      - [ステーキング](#ステーキング-3)
  - [記法及び定義について](#記法及び定義について)

## 導入
この文書では、Partisia Blockchainを支える、技術の側面及びエコノミーの側面について紹介します。Partisia Blockchainは個々の独立したノードにより運営されるものです。

Partisia Blockchainは、セミパーミッションドブロックチェーンであり（ノードになるためにDAOの許可がいるから）、パブリック/プライベート情報に対して計算サービスを提供します。Partisia Blockchainは、全てのプラットフォーム間に対してプライバシー及びインターオペラビリティを解決するよう設計されています。

- プライバシーはMPCのような分散型ゼロ知識計算の仕組みによって、最大化されます。データは全てのプロセスにおいて保護されているからです。
- インターオペラビリティは分散制御されており、プライバシーが保たれるオラクルサービスによって、最大化されます。

分散型インフラストラクチャとして、Partisia Blockchainはノードによって運営されます。Partisia Blockchain Foundationの役割は、トークンを生成し、資金をソフトウェアの開発に適切に割り当てることです。
ノードの種類は、4種類あります:
- リーダーノード：ノード運営に登録作業が必要ではなく、ブロックチェーンデータの読み取りのみが可能であるノードです。他のノードとは異なり、報酬はありません。
- ベイカーノード：コンセンサス及びガバナンスのような、ブロックチェーン自体の運営を担当します。
- ZKノード：ゼロ知識計算サービス（MPC）を提供するノードです。
- オラクルノード：オラクルサービスを提供するノードです。

Partisia Blockchain上で、外部コインを支払いに使うサービスとして、BYOC（Bring Your Own Coinの略）が存在します。
BYOCサービスでは、別のチェーンからネイティブ/非ネイティブトークンを持ち込み、Partisia Blockchain上でBYOC Twinsとしてブリッジを行います。ガス代や任意の支払いに対し、BYOC Twinsとしてブリッジされた別チェーンのトークンを使用でき、使用されたBYOC Twinsはノード運営者に分配されます。必要に応じ、分配されたBYOC Twinsは元のチェーンに戻すことが出来ます。
一方で、MPCトークン自体のユーティリティはPartisia Blockchain上でのステーキングの用途に限定されています。

このため、MPCトークンをステークしてノードを運営し、技術的にはネットワークが強化されますが、別チェーンのトークンによって報酬を得るため、トークンエコノミーは分離されることとなります。
エコノミーとしては、ノード運営者は手数料の請求者であり、MPCトークンが参入障壁となります。また、より多くのステーキングがより多くの手数料の取得につながるため、動的な参入障壁にもなります。図1は、ここまでのトークンエコノミーを図示しています。

また、基本設計は次の通りです：
- ブロックの生成、コンセンサス及びガバナンス（L1サービス）は全て審査済みのベイカーノードにより運営されます。
- ZK/オラクルサービス（L2サービス）はBYOCやZK計算、トークンブリッジのようなサービスを含めて、審査済みのZK/オラクルノードにより提供されます。

図2ではL1サービス（ブロック生成等）とL2サービス（ZK/オラクル）とでサービスを図示しました。BYOCは審査済みのオラクルノードによってサービス提供されますが、BYOCサービス自体はL1サービスにも依存しているため、[技術・エコノミーの概略](#技術エコノミーの概略)で説明するように、2種類のサービスに対して別々のインセンティブモデルが成立します。技術的には、全てのサービスはパブリック/プライベートなスマートコントラクトにより提供されます。ZK/オラクルサービスはL1サービスに依存するため、BYOCを定義するスマートコントラクトを利用することで、L1/L2サービスの両方を利用することになります。

Partisia BlockchainはL1としてコンセンサス・ガバナンスを持った通常のブロックチェーンがあり、L2として相互利用可能なZK/オラクルサービスのSaaSでもあります。このような設計を選択したのは、技術的及びエコノミー的な理由があります。

技術的な面からは、L1サービスによりPartisia Blockchainはプラットフォームの垣根を超え、ZK/オラクルサービスを同じ品質で提供することが出来ます。
- ブロックチェーンは汎用ZK計算を実行できるように設計されていること。特に、ブロックチェーンサービスはより信頼性の高いZK計算技術を提供するのに適したコンセンサス、完全性を持っています。
- クロスチェーン機能は同じセキュリティモデルに依存していること。
- ブロックチェーンサービスがZK/オラクルサービスの提供に対応できる審査済みのノードにより提供されること。このために、既存のブロックチェーンやブロックチェーン上のサービスは、APIを使って統合するのと同じくらい簡単に、Partisia Blockchainに統合し、プライバシーやインターオペラビリティの課題を解決できます。（ここの意味、全然わかんないですね。なんで・・・？）

エコノミーの面からは、ブロックチェーンにより適したインセンティブ提供が可能になります。まず、収益分配によりP2Pレイヤーにおけるノードの行動を一致させるようデザインされ、Partisia Blockchain上の様々なサービスに対して、望ましい行動に対してインセンティブを与えるよう、設計されています。
一方で、ステーキング機構によって、ペナルティシステムが導入され、ユーザーの望ましくない行動が抑制されます。またブロックチェーンサービスにより、ZK/オラクルノードやサービスを選択し、価格付けするためのノードに対するレピュテーション市場、つまりトラスト市場を提供します。

最後に、BYOC機能は、他のL2ソリューションと同じようにPartisia Blockchainを他のL1ブロックチェーンと連動させます。Partisia Blockchainに他のL1から提供されたコイン・トークンによって全ての支払いが実行されることからわかるでしょう。この機能はネットワークの拡大に重要な意義があり、最終的には技術・経済的なインセンティブの両方を強めます。

言い換えると、高度な分散型ZK計算技術を適用するための技術・エコノミー上の困難は、Partisia Blockchainにおいては全て処理されているのです。

このイエローペーパーでは、[技術・エコノミーの概略](#技術エコノミーの概略)で技術・エコノミーの概略を説明し、ブロックチェーンサービスについては[L1ブロックチェーンサービス](#l1ブロックチェーンサービス)で、ZK/オラクルサービスについては[Zero Knowledge 計算](#zero-knowledge-計算)、[オラクルサービス](#オラクルサービス)で説明を行います。

## 技術・エコノミーの概略
パブリックなブロックチェーンは暗号学及びエコノミーの機構をベースとして独立したノード運営者がネットワークを運営し、誰もが利用可能になるようインセンティブ設計がなされています。
このセクションでは、基本的な技術・エコノミーからの説明を行います。サービス自体の説明は[Zero Knowledge 計算](#zero-knowledge-計算)、[オラクルサービス](#オラクルサービス)で行います。

### 全体の構造
Partisia Blockchainのインフラは図3に示され、それぞれのレイヤーは以下に記載する内容を達成するためにデザインされています：
- P2P接続：高速かつロバストな接続を達成するために設計されています
- コンセンサス・ステート：高速かつロバストなコンセンサス・ファイナライズの達成のために設計されています
- パブリックスマートコントラクト：単純で効率的かつセキュアなパブリック計算の実行のために設計されています
- プライベートスマートコントラクト：単純で効率的かつセキュアなZK計算の実行のために設計されています
- API：Partisia Blockchainをプラットフォーム間で利用するのを単純化するために設計されています
- ビルトインインターオペラビリティアプリ：単純で効率的かつロバストでセキュアな価値移転及び秘密データの利活用のために設計されています

### アカウントの作成
ノード運営者にとって最初のアクションはPartisia Blockchainにおけるアカウントの作成になります。全てのMPCトークン所有者は、ガバナンスレイヤーの一部として、限られた数のアカウントを作成できます。
Partisia Blockchainを直接利用しないユーザーに対するサービス提供者は、ユーザーのKYCを担保しなければなりません。この促進のため、分散型プライバシーKYCシステムがPartisia Blockchainのサービスとして提供されます。つまり、Partisia Blockchain上のすべてのサービスがAMLからデータ保護規則まで完全に準拠することが出来るようになります。

### ノード運営者
Paritsia Blockchainは、ノードを接続するP2Pネットワークにより動作するプロトコルの集合体です。分散型ネットワークとして、最小意思決定単位はノード運営者であり、この集合体がPartisia Blockchainでの意思決定を行います。
ノード運営者には、以下4種類が存在します：
- リーダーノード：
  - 役割：Partisia Blockchainのデータを読み取りのみ行うノードであり、外部サービスやアプリ提供者のような、Partisia Blockchain上での活動を追跡する必要がある方が利用します。
  - 審査：リーダーノードの作成・運営には審査が無く、誰でも運営可能です。
  - 報酬：リーダーノードには報酬はありません。
  - ステーキング：リーダーノードの運営にはステーキングは必要ありません。
- ベイカーノード：
  - 役割：コンセンサス・ガバナンス等のブロックチェーンのサービスを提供します。
  - 審査：ベイカーノードは、分散型審査システムを通して、外部のバリデータにより審査されます。
  - 報酬：ベイカーノードは、L1サービスに対する手数料を報酬として共有します（例：ガス代）。
  - ステーキング：10K$相当のMPCトークン（価格オラクルによって調整されます）のステーキングが必要です。※discordの現在の議論だと固定値になっています。
- zkノード：
  - 役割：MPC/ZK計算サービスを提供します。
  - 審査：ZKノードは、分散型審査システムを通して、外部のバリデータにより審査されます。
  - 報酬：ZKノードは、MPC/ZK計算サービスに対する手数料（からL1手数料を差し引いた）を報酬として共有します。
  - ステーキング：25K$相当のMPCトークン（価格オラクルによって調整されます）のステーキングが必要です。※discordの現在の議論だと固定値になっています。
- オラクルノード：
  - 役割：BYOCやトークンブリッジのような、様々なオラクルサービスを提供します。
  - 審査：オラクルノードは、分散型審査システムを通して、外部のバリデータにより審査されます。
  - 報酬：オラクルノードは、オラクルサービスに対する手数料（からL1手数料を差し引いた）を報酬として共有します。
  - ステーキング：100K$相当のMPCトークン（価格オラクルによって調整されます）のステーキングが必要です。※discordの現在の議論だと固定値になっています。

#### ノード運営者の審査
パブリックなセミパーミッションドブロックチェーンなため、ノード運営要件を満たした全てのエンティティは分散型審査プロセスを開始できます。

審査プロセスはPartisia Blockchain上のスマートコントラクトにより実行され、Partisia Blockchain Foundationはこの審査において特定の役割を持ちません。

審査プロセスは次の通りです：
1. ノード運営者はPartisia Blockchain上でアカウントを作成します
2. ノード運営者は以下の情報を公開します
   1. ノードを管理する法人の名称及びウェブサイト
   2. ノードを管理する法人の所管地域及びサーバーの所在地域
   3. ノードを管理する法人が単独のノードのみを運営していることを明記した確認書類（ベイカーノード、ZK、オラクルノードの全てを同一ノードで提供することはかまいません）
   4. 以上の情報がPartisia Blockchain上の他の1以上のバリデータにより確認されていること
3. ノード運営者はステーキングを行い、テストを実施します
   1. ノード運営者はベイカー/ZK/オラクルノードの運営に必要なMPCトークンをステーキングします
   2. ノード運営者は各ノードに対応した運用テストを行います
4. ノード運営者は以下の条件を満たした場合、ネットワークに反映されます
   1. 公開されている情報が、Partisia Blockchain上の他の1以上のバリデータにより確認されている
   2. 十分なMPCトークンがステーキングされている
   3. 運用テストが成功した
   4. 審査コントラクトに手数料が支払われた

ノード運営候補者は上記の処理に必要な費用をスマートコントラクトに対してBYOCで支払いを行います。このコストは外部検証、他の審査済みZK/オラクルノードにも影響するテストや審査に係るトランザクション手数料です。
外部検証により、現存のノード運営者による投票での検証を置き換え、既存のノード運営者により新規参入が阻害されるような状況を回避出来ます。ネットワークの成長とともに、ノード運営者はトラスト市場の一部として、各ノード運営者のトラストスコアはネットワーク上のサービス市場に統合されます（ここよくわかんないです）。

審査ステータスは、下位20%のスコアであるノード運営者を対象として、早期取り消しされます。それ以外においては、ノードの審査ステータスはノード運営者によってのみ、取り消しされます。

#### ノード運営者の選択方法
Partisia Blockchainの提供する様々なサービスでは、特定のタスクを実行するために、ノードのサブセット（小集団）が必要となる場合があります。

例えば、L1サービスはベイカーノードのセットにより運営されています。ベイカーノードの合計数が1000未満の場合、全ベイカーノードによるサブセットが作られ、1000を超えた場合、無作為に選ばれた1000のベイカーノードをサブセットとし、運営します。

ZK/オラクルサービスは、ZK/オラクルノードのサブセットにより提供されます。しかし初期のセット選択においては、均一な分布として、全てのZK/オラクルノードは平等なものとして扱われます（初期はトラストスコアが存在しないため、十分なノード運営データが収集されたタイミングでトラストスコアベースでの割り振りになると思います）。

ノード数の増加に応じ、セット選択はエコノミーモデルの部分として重要となり、規制への対応も必要となるなど課題があります。

- 直接選択方式：
  - ユーザーがノード運営者を直接選択する方式です。
- ユーザー定義の領域内ランダム選択方式：
  - ユーザーが定めた条件に当てはまるノード全てからランダムに選択する方式です。
- ユーザー定義のステーキング制限方式：
  - 条件に合致する全てのノードからランダムに選択します。
  - トラストスコアにより調整されます。
  - ランダムな選択はトラストスコアによって調整されます。
- トラスト市場方式：
  - 入札式・トラストスコアを組み合わせ、市場原理の下にノードを選択し、費用を徴収します。

### スマートコントラクト
他のブロックチェーンと同様、スマートコントラクトは、ネットワークに対して望む操作が行われるようプログラムするための開発者インターフェースです。Partisia Blockchainにおいては、3種類のスマートコントラクトとしてパブリック/プライベート/システムスマートコントラクトが存在し、パブリック/プライベート情報を処理します。

#### パブリックスマートコントラクト
パブリックスマートコントラクトは、他のブロックチェーンでの通常のスマートコントラクトによく似ています。コントラクトは次のタイプのインターフェースを持ちます。
- 生成：コントラクトをブロックチェーン上へのデプロイを可能にします
- インタラクト：コントラクトが命令を実行し、他コントラクト等との連携を可能にします
- 削除：コントラクトを削除できるようになります。システムコントラクトは自動的に一定時間の後に契約解除を行います。

パブリックスマートコントラクトは、コントラクトの状態や実行時のトランザクションを含んでおり、イベントトランザクション（他のトランザクションにより誘発されるトランザクション）を通じて他のコントラクトと相互作用できます。

#### プライベートスマートコントラクト
プライベートスマートコントラクトは、ブロックチェーン上でのZK計算（MPC）を調整します。[Zero Knowledge 計算](#zero-knowledge-計算) では、ZK計算がどのように処理・調整され、様々なスマートコントラクトが関与していることを紹介します。

#### システムスマートコントラクト
システムスマートコントラクトは、ガバナンスの実装です。システムスマートコントラクトは、アカウントと残高を調整でき、別のシステムスマートコントラクトの作成が可能です。スマートコントラクトを作成し、チェーン上のアカウント・コンセンサスの処理方法を変更できます。

### ブロックチェーンの利用に対する費用の決定、支払い方法
Partisia Blockchainにおいて手数料はBYOC Twins（外部チェーンのコイン・トークンをPartisia Blockchainに移行したもの）によって支払われます。BYOC Twinsを手数料として支払うタイミングは、スマートコントラクトの利用またはトランザクションの送信のみです。

図4ではPartisia Blockchain上で、外部チェーンのコインがユーザーとノード運営者のBYOCアカウントやスマートコントラクトをどのように移動するかを表示しています。簡単に説明すると、次の通りです：ユーザーが外部チェーンのコインをBYOCアカウントからブリッジ（預け入れ、送金）し、スマートコントラクトの実行・利用にBYOC Twinsを支払う例です。スマートコントラクトはベイカーノード及び指定されたZK/オラクルノードにより実行され、手数料が支払われます。BYOC Twinsはタスクの完了に伴い、スマートコントラクトからアンロックされます。BYOCへの出し入れはキューシステムにより管理されます。

図4に示されるように、外部チェーンのコインとBYOCアカウントは保護機構であるBYOCオラクルサービスにより管理されます。外部チェーンのコインは依然として外部チェーン上に存在し、BYOCオラクルサービスによって、BYOCの生成・消滅は管理されます。[Bring Your Own Coin (BYOC)](#bring-your-own-coin-byoc) において、BYOCオラクルをより詳細に説明します。

#### 価格決定、支払い方法
ここでは、ユーザーが支払う価格（価格決定スキーム）とノードの受け取る報酬（支払いスキーム）を別々に扱います。

_価格決定スキーム_ は、ユーザーによって支払われる料金の決定方法であり、初期価格はPartisia Blockchain Foundationによって定められる"公示価格"です。

ノード運営にかかる市場予測及びコスト推定より、次のように公示価格は決定されています（全て暫定値です）：
- ベース手数料：L1サービスの利用手数料です
  - ネットワーク手数料：5 ¢ /kb
  - CPU手数料： 5 ¢ / 1000 命令
  - ストレージ手数料：1 ¢ /kb /year
- ZK/オラクル手数料：L2サービスの利用手数料です
  - BYOC
    - 移転価値の0.1%（25USDを最低移転量とし、最低手数料を25¢とします）
  - ZK計算
    ※ この価格は3つのZKノードが存在するケースであり、より多くのZKノードを利用する場合は価格が変動します。
    - ブロックチェーンの手数料はベース手数料により決定されます
    - MPC 乗算手数料：5¢ / 1000 乗算
    - MPC triples計算手数料：5¢ / 1000 triples
    - ステーキング手数料：月ごとにロックされているステーキング量の1%であり、ZK計算に対してロックする値はユーザーにより決定されます。
  - トークンブリッジ
    - 移転価値の0.1%（25USDを最低移転量とし、最低手数料を25¢とします）

"公示"手数料は今後変更される可能性があり、将来的には、手数料設定やZK/オラクルサービスのノード選定に対しても、市場メカニズムが導入される予定です。ただ、現在の価格では、トークン転送は1¢の手数料です。

_支払いスキーム_ は、当該トランザクションの処理に関わったノード運営者間で手数料がどのように分配されるかを規定します。

L1ブロックチェーンサービスからの総収入を *R* とすると、*R* はブロックチェーンエポック（初期では1000ブロック）ごとにベイカーノードに分配されます。 *R* はネットワーク、CPU、ストレージ利用量にベース手数料単価をかけた料金です。*R* の配分については、[L1ブロックチェーンサービスの支払いスキーム](#l1ブロックチェーンサービスの支払いスキーム) のインセンティブ設計において説明します。

(L2)ZK/オラクルサービスからの収入はほとんどの場合、サービスを提供したZK/オラクルノードに対して等しく分配されます。[Zero Knowledge 計算](#zero-knowledge-計算), [オラクルサービス](#オラクルサービス) において、ZK/オラクルノードに対してどのように報酬が支払われるかより詳しく説明します。

#### スマートコントラクトの支払いメカニズム
ユーザーがスマートコントラクトを利用するたびに、トランザクション手数料としてBYOC Twinsがスマートコントラクトに移動します。このガスの一部はL1ブロックチェーンサービス（ネットワーク、CPU、ストレージ手数料）として使われ、一部はL2サービス（ZK/オラクル）に消費されるかもしれません。

最初にコントラクトをデプロイするとき、手数料はデプロイのために利用され、あまりはデプロイ直後にスマートコントラクトアカウント（SCアカウント）に預けられます。このSCアカウントの保有量は将来的なトランザクション手数料や、定期的に消費されるストレージ手数料などに利用されます。また、手数料は他のスマートコントラクトによって、つまりイベントトランザクションを介しても供給される場合があります。支払いがユーザーから直接であるか、それともSCアカウントからとなるかを決定するのはスマートコントラクトの開発者となります。

パブリック/プライベートスマートコントラクトは、定期的にストレージ手数料を支払う必要があり、支払えない場合、ブロックチェーンから削除されてしまいます（ガバナンスプロセスにより復活させることは可能です）。これらの手数料のために、コントラクトは常に残高を保有する必要があります。コントラクトに手数料を供給するため、システムはコントラクトのSCアカウントに対して、自動的にトランザクション手数料の残りを移動させます。例えば、ユーザーAが、コントラクトBに対して1000ガスを使用するトランザクションを送信したとします。この時、実際に消費される手数料が800ガスであれば、お釣りの200ガスはコントラクトBのSCアカウントに預けられ、定期的なストレージ手数料への支払いに使われます。

実際のコントラクト利用のトランザクションにおいては、ブロックチェーンにおいてネットワーク及びCPU手数料も発生します。

トランザクションがブロックチェーンに送信されると、ユーザーの残高から割り当てられた手数料が差し引かれます。その後、関連するイベントトランザクションの送信等によるネットワーク、CPU手数料が差し引かれ、未使用分の手数料はSCアカウントに転送され、ストレージ手数料等に利用されます。

支払われた手数料はL1ブロックチェーンサービスの手数料としてベイカーノードに支払われるか（[L1ブロックチェーンサービス](#l1ブロックチェーンサービス) 参照）、ZK/オラクルサービスの提供を行ったZK/オラクルノードに分配されます（[Zero Knowledge 計算](#zero-knowledge-計算), [オラクルサービス](#オラクルサービス) 参照）。

Partisia Blockchainが稼働し続けるために、以下に記載されているガバナンスコントラクトは、手数料なしで利用できます。
- BYOC デポジットコントラクト
- ベイカー報酬分配コントラクト
これにより、Partisia Blockchainのユーザーはより多くのBYOCを持ち込み、流動性不足に陥ったということがあっても、チェーン自体が停止することは避けることが出来ます。

### 取引所リスク
BYOCは、独立した価格ボラティリティを持つ異なるコインをPartisia Blockchain上に持ち込みます。このモデルにおいて生じうる、ユーザー及びノード運営者のリスクは、次のように解決できます。

このリスクは主にBYOC Twinsを元々のコイン・トークンの残高と一致させて表現することにより解決されます。つまり、ユーザーがETHをBYOCアカウントに追加した時にBYOCアカウントの残高はETH BYOC Twinsとして反映されます。ETH BYOC Twinsを手数料としてノード運営者に支払うとき、例えば10ETHをユーザーが使えば、ノード運営者は10ETHを受け取るということです（前節では、USD建てで料金が計算されていましたが、支払いはUSD建てとして表示されるのではなくそれぞれのBYOC Twins建てで表示されます）。

このような多通貨システムにおいて、BYOCがサポートする通貨ごとに、Paritisia Blockchain上で価格データを提供する必要があります。異なるBYOC Twinsに対して、価格データはUSDを基準として設定されており、価格データ提供は専用のオラクルによって収集されたマーケットデータを基に行われます。

BYOC Twinsが移動し、スマートコントラクトによってロックされるタイミングでBYOCコインの価格は固定されるため、このタイミングでBYOC Twins建てでの手数料がわかります。

例として、10ETH BYOC Twinsを所有するユーザーを考えてみましょう：
- ETHがユーザーのアカウントに転送された時
  - ETH BYOC Twinsの残高：10 ETH (以下BYOC Twinsを省略)
  - ETH BYOC Twinsの価格はUSD建てで調整されます
  - タスク手数料：1.1 ETH (この段階ではあくまでコントラクト利用前の見積もりでした)
- ユーザーがコントラクトの利用を開始した時
  - ETH BYOC Twinsの残高：10 ETH
  - ETH BYOC Twinsの価格はUSD建てで調整されます（先ほどより下落したとします）
  - タスク手数料：1.2 ETH
- ノード運営者への支払い時
  - ETH BYOC Twinsの消費量：1.2 ETH
  - ノード運営者の収益：1.2 ETH

### ステーキング
ステーキングはPartisia Blockchainのコア機能であり、MPCトークンの唯一の用途です。
このように、ステーキング機能はノードの運営のための参入障壁であると同時に、Partisia Blockchainのユーザーに対する信頼性、責任として機能します（スラッシングがあるため）。

ノード運営者はステーキングコントラクト上にステーキングを行い、dispute発生時にペナルティとして徴収される場合があります。以下のようにステーキング時のdisputeは処理されます。

- dispute 開始
  - Partisia Blockchain上にアカウントを持つ方であれば誰でも、チャレンジャーとしてdisputeを開始できます。
  - チャレンジャーはdisputeコントラクトに初期手数料を支払います。
  - disputeの種類に応じて、チャレンジャーは追加でMPCトークンをデポジットする必要があります。
- ステークのロック
  - ステークされたMPCトークンは、特定のコントラクトによってロックされます。
- dispute 解決
  - disputeの解決は、disputeコントラクトにより実施されます。
  - 明確に判定できる不正行為の場合、分散型dispute処理システムで解決します。
  - 明確に判定できない不正行為の場合、MPCトークン保有者及びノード運営者の投票により解決されます。
  - disputeの結果は公開されます。
  - MPCトークンによる補償が生じる場合、即座に補償金は支払われます。
- 支払い
  - ロックされたMPCトークンが補償金として支払われます。

#### ベイカーノードのステーキング
何らかの種類のノード審査を通過したノードは全て、ベイカーノードとしてのL1ブロックチェーンサービスの提供が義務付けられています。

年一度の自動ライセンスを通過し、ステーキングしたMPCトークンが特定の閾値を超えているノードについては、自動的にベイカーノードの審査を通過します。審査を通過したベイカーノードのリストは公開されます。

ベイカーノードのステーキング額はUSD建てで10,000$です（今後変更の可能性あり？）。

明確に判定できる不正行為があった場合、ステーキングされたMPCトークンはロックされ、ノード運営者は一時的に審査ステータスが取り消されます。ロックされたMPCトークンは分散型disputeプロセスに基づき、補償金として支払われます。明確な不正行為や不能状態としての例は次の通りです：
- プロポーザーとしての_ブロック生成の失敗が2回_となること
- 同一ブロックに対して、_二重署名_すること

トラストスコアは明確な不正行為や不能状態を基に計算されるよう、設計される予定です。

#### ZKノードのステーキング

年一度の自動ライセンスを通過し、ステーキングしたMPCトークンが特定の閾値を超えたノードは、ZKノードとしての審査を通過します。審査を通過したZKノードのリストは公開されます。

ZKノードのステーキング額はUSD建てで25,000$です（今後変更の可能性あり？）。加えて、 タスクを実施する場合、_n_ 個ZKノードの集団で実施する場合、ユーザー指定の期間・金額について保険としてMPCトークンをロックする必要があります。このような保険としての追加ステークは、ユーザーがオプションとして追加で手数料を支払った場合に実施されます。保険ステーク背景としては、ZKノードの実施するタスクによって得られる情報の真の価値はユーザーのみが知っているためです（ちょっとよくわかんないです）。

例として、ZKノードに指定されたタスクの保険ステークが10,000$であり、_n=5_の場合を考えてみましょう。この場合、各ZKノードは最低2,000$分の追加ステーク（未ロック）を所有する必要があります（この場合の未ロックとは、他のタスクに対してロックされていない、という意味です）。

この閾値に適合する審査通過済みのZKノードだけが、このZKノードタスクに対してランダムに割り当てられることとなります。

Partisia Blockchainは、3回以上ZK計算への参加に失敗するなどの明確な不正行為、不能状態を検出します。

このような事態が発生した場合、ステーキングされたMPCトークンはロックされ、ノード運営者は一時的に審査ステータスが取り消されます。ロックされたMPCトークンは分散型disputeプロセスに基づき、補償金として支払われます。明確な不正行為や不能状態としての例は次の通りです：
- プロポーザーとしての_ブロック生成の失敗が2回_となること
- 同一ブロックに対して、_二重署名_すること

トラストスコアは明確な不正行為や不能状態を基に計算されるよう、設計される予定です。

#### オラクルノードのステーキング
年一度の自動ライセンスを通過し、ステーキングしたMPCトークンが特定の閾値を超えたノードは、オラクルノードとしての審査を通過します。審査を通過したオラクルノードのリストは公開されます。

オラクルノードのステーキング額はUSD建てで100,000$です（今後変更の可能性あり？）。特定のオラクルタスクに対して必要な閾値を満たしたオラクルノードのみが、タスクに対してランダムに割り当てられます。

Partisia Blockchainは、以下のような明確な不正行為、不能状態を検出します：
- 3回以上トランザクションの実行に失敗すること
- オラクルスマートコントラクトの外部で無許可に資金を移動すること

このような事態が発生した場合、ステーキングされたMPCトークンはロックされ、ノード運営者は一時的に審査ステータスが取り消されます。ロックされたMPCトークンは分散型disputeプロセスに基づき、補償金として支払われます。

トラストスコアは明確な不正行為や不能状態を基に計算されるよう、設計される予定です。


### デリゲーション（共同ステーキング）
全てのトークン所有者がノードを運営することができるわけではなく、またステークに必要なMPCトークンを十分に保有しているわけでもありません。このようなMPCトークンを有用に活用するため、共同でのノード運用が導入されます。

この方法では、少額のMPCトークンホルダーが合同でノードを運営し、手数料を得ることが出来ます。この時、MPCトークンホルダーはステーキングに対して共同で責任を追うことに注意ください。

### スコアリング
Partisia Blockchainでは、ノードの評価がノード選択・価格決定のプロセスに反映される、トラスト市場に将来的に移行することを想定しています。その核となる技術が、ノードのスコアリングです。ネットワーク開始当初から導入され、段階的にトラスト市場を構成するプロトコルに組み込まれていきます。

スコアリングは、次のような第三者指標に基づいて行われます：
- ベイカーノードとしての活動
  - 経験：ベイカーノードであったブロック数
  - ブロックプロポーザー：生成したブロック数
  - バリデーター：署名したブロック数
  - 報告された不正行為
- ZKノードとしての活動
  - 経験：処理したZKタスク数、ステークしたトークン数
  - 稼働状況（よくわかんないです）
  - 報告された不正行為
- オラクルノードとしての活動
  - 経験：処理したオラクルタスク数、ステークしたトークン数
  - 稼働状況（よくわかんないです）
  - 報告された不正行為

今後、情報公開状況等、[L1ブロックチェーンサービスの支払いスキーム](#l1ブロックチェーンサービスの支払いスキーム) で説明するP2Pレイヤーのインセンティブに関連するような他の事項が含まれる可能性があります。

### ソフトウェアの更新
Partisia Blockchainを構成するソフトウェアのアップデートは、分散型ガバナンスによって管理されます。

ソフトウェアのアップデートは、以下の2ステップを経て、エコシステムに申請され、実装されます：
- ノード運営者が可否投票します
- 投票を通過すれば、ノード運営者はソフトウェアアップデートを実施します

ノード運営者は、新しいソフトウェアにアップデートするか否かを選択する投票者となります。しかし、ソフトウェアのアップデートは他のノード運営者に影響を与える可能性があるため、以下の投票ルールを適用します：
- リーダーノード：リーダーノードの関わるアップデートには、全ベイカーノードの2/3及びベイカーノードの保有するステーク済みMPCトークンの50%以上の賛成が必要です
- ベイカーノード：ベイカーノードの関わるアップデートには、全てのベイカーノードの2/3及びベイカーノードの保有するステーク済みMPCトークンの50%以上の賛成が必要です
- ZKノード：ZKノードの関わるアップデートには、全てのベイカーノードの2/3及びZKノードの保有するステーク済みMPCトークンの50%以上の賛成が必要です
- オラクルノード：ZKノードの関わるアップデートには、全てのベイカーノードの2/3及びオラクルノードの保有するステーク済みMPCトークンの50%以上の賛成が必要です

## L1ブロックチェーンサービス
L1ブロックチェーンサービスは、Partisia Blockchain上でノード間の適切なコミュニケーション、コンセンサスを確立するためのコアシステムです。L1ブロックチェーンサービスは、Partisia Blockchain上に構築される全てのサービスの基盤として機能します。

### コンセンサスとブロック生成
Partisia BlockchainではFastTrackと呼ばれる、ファイナライズが得られる委員会タイプのコンセンサスモデルを利用しています。

この委員会はL1ブロックチェーンサービスを提供するベイカーノードによって構成されます。既に説明しましたが、審査済みのベイカーノードの中から、1000個まで取り出した委員会が1つ存在します。

コンセンサスモデルは次の3つの部分から構成されます：
- Proof of Verification(PoV)： 新たなブロックに含まれる全トランザクションを処理したバリデーターから得られたことを検証したことを持って署名します。つまり、PoVはバリデーター自身がブロックの内容をここに検証したことを証明する署名です。
- FastTrackコンセンサス：ファイナライズを与える高速なコンセンサスシステムです。
- インセンティブ設計：[L1ブロックチェーンサービスの支払いスキーム](#l1ブロックチェーンサービスの支払いスキーム) で説明する、P2Pネットワークにおけるブロックの伝搬と接続性の保持をインセンティブとして与えます。

図5では、コンセンサスモデルを図示しており、以下の3つのセクションで説明します。

コメント：この図では、
- 準備フェーズ
  - 委員会：ベイカーノードの中から1000台を選択して構成
  - 委員会の中からプロポーザー（ブロック生成者）を選択
  - それ以外の委員会メンバーはバリデーター
- ブロック生成フェーズ：
  - プロポーザーはトランザクションを検証し、ブロックを生成
  - インセンティブとして、トランザクション手数料を取得
- 検証フェーズ
  - バリデーターはブロックを検証し、PoVを生成し、署名
  - バリデーターは署名を提出
  - 各ノードが委員会中の2/3以上の署名を収集し、PoJを作成
- ファイナライズフェーズ
  - PoJを直前のブロックに対するProof of Finalizationとして扱う
  ※dBFTと同じ仕組み（だと思います）
  - 署名の伝搬状況から、Info matrixを作成
- ネットワーク反映フェーズ
  - 新しいプロポーザーを選択
  - 新しいブロックを作成し、プロポーザーを選択する際に関連したノードをシャットダウンする（なんでかわかりません）
- 上の3ステップは30秒の間で実施される
- 1エポック（1時間）経過後、Info matrixをインセンティブコントラクトに送付
- Info matrixは公開され、報酬の割り当てが実施される

ということを説明してます。よくわからないところは以下のところ見てください・・・・。

#### Proof of Verification
Proof of Verification(PoV)は、バリデーターがブロックに証明するとき、ブロック内のトランザクションが全て証明できることを確認したという保証になります。PoVの目的は、バリデーターがプロポーザー、他バリデーターから受け取ったブロックをそのまま検証せず署名のみしてしまうことを避けることです。セキュリティとして重大な問題を引き起こすわけではありませんが、検証作業が一部の誠実なバリデーターに集中してしまうのを避けることが出来ます。
検証者ってなに？？（わかってない人）

PoVは以下の3点を保証します。
- バリデーターがブロックチェーンの状態を保持していること
- 検証者がブロックチェーンの状態を保持していること
- 署名したいバリデーターは全て、検証作業を実施していること
すなわち、検証作業をしないことによるディスインセンティブを生じさせています。

これらの3点は、それぞれのバリデーターが保持するブロックチェーンの状態のハッシュとしてPoVを構成することで達成されました。より詳細に説明すると、IDを負荷した状態で、ブロックチェーンのステートツリーをハッシュ化します。このため、バリデーターと検証者の両方が、ステートにアクセスすることが出来ます。更に、PoVはバリデーターごとに異なる（これなんでですかね？）ため、PoVの生成を外注したり、他に任せることはノード運営者にとって大きなリスクになります。
PoVの生成を外注した場合、受注者はPoVが正しいかを自身で検証することが出来ません（なぜなら、PoVを逆生成することは出来ず、検証作業はPoVの生成作業と等価だからです）。そのため、誤っていることが判明した場合、ステークしているMPCトークンがバーンされてしまいますので、非常に危険です（あくまで、困るのは発注者であるノード運営者であり、受注者ではありません）。

#### FastTrack consensus
FastTrackコンセンサスは失敗時に回復が可能なoptimisticなプロトコルで、全ベイカーノードの2/3以上のノードにおいて合意形成が保証されます。(どうやって復旧すんねん) Optimisticなプロトコルの場合、1つのプロポーザーが選出され、継続的にブロックを生成し、委員会に所属する他のノードがバリデーターとなり、ブロックを検証し署名します。このプロトコルでは、ブロックの生成数を定数として決めており、一定数のブロックが作成された場合、もしくは"シャットダウン"が起きた時、新しいプロポーザーが選出されます。

Partisia Blockchainではほぼすべてのトランザクションはユーザーから支払われる手数料が含まれるので、トランザクション手数料により運営されています。トランザクションの迅速な処理を保証するため、トランザクションは即時ブロック生成により、処理されます。これを、Eager FastTrackコンセンサスと呼称しています。プロポーザーが活動的である限り、トランザクションが生じればすぐ、ブロックが生成されチェーンに追加されます。30秒間の間トランザクションがなかった場合でも、"heartbeat block"としてノードの活動証明としてブロックが生成されます。

コンセンサスとファイナリティはProof of Justification(PoJ)とProof of Finalization(PoF)によって与えられます：
- PoJ は現在のブロックを検証する、委員会中の2/3以上のバリデーターの署名（PoV）を集めたリストです（そのため、ノードごとにPoJはことなります）
- PoF は直前のブロックがファイナライズされたことの証明であり、現在のブロックに対して実施されるPoJにより、間接的に成立します

つまり、全ノード（バリデーター？）の2/3がブロックを検証し、PoVを生成し署名した時点で、ブロックはファイナライズされます（それぞれのノードが、PoJを生成することでネットワークの2/3が合意したことを理解している状態自体をファイナライズされたと呼んでいると言って良いと思います）。PoF自体はP2Pネットワークに直接送信されるものではありませんが、分散された形でノードごとに存在しており、次のブロックに対して生成されるPoJにより間接的に明らかになります（今のブロックに対してPoJが生成されたということは、直前ブロックまでの検証が2/3のバリデーターに対して完了したということだから）。ファイナライズ自体が分散型として認識されているために、ネットワークの同期に関わらず、迅速なコンセンサスが得られます。

30秒間新しいトランザクションが生成されなかった場合、プロポーザーがブロックの生成を中断した（もしくはネットワーク問題によりブロック送信が出来なくなった）と判定し、回復メカニズム（シャットダウンプロセス）が開始されます。シャットダウンプロセスは、準同期BFTタイプのメカニズムで、その目的は、委員会に所属している全ノードが、ファイナライズされたブロックがどのブロックか確認することです。1つのノードから見て、PoJにより検証されたブロックがキャンセルされる場合がありえるので、最大1ブロックまでのロールバックがあります。シャットダウンプロセスの時には、全委員会所属ノードが最終ファイナライズブロックを把握できるようにするため、シャットダウンブロックと呼ばれる特別なブロックを生成し、チェーンに追加します。
シャットダウンブロックがチェーンに追加された後、委員会メンバーからプロポーザーを選出し、チェーンを再スタートします。図6にて、FastTrackコンセンサスの説明を作成しました。

図6
- Confirmed:
  - ノードが直前のブロックのPoJを作成し、更にその前のブロックのPoFが成立
  - プロポーザーが次のブロックを作成
  - バリデーターがPoVを作成
  - ノードがPoJを作成し、直前のブロックのPoFが成立

- Timeout:
  - ノードが前ブロックのPoJを作成しなかった
  - シャットダウンプロセス開始
  - 委員会のリセット及び新プロポーザー選出
  - 新プロポーザーがブロックを作成
  - ノードがPoJを作成し、直前のブロックのPoFが成立

ノードが委員会に参加・脱退するためには、変更手続きが必要となります。スマートコントラクトにより処理され、古い委員会からのサインオフー再サイン集約で対応されます。80%の古い委員会メンバーがサインオフした場合のみ、委員会の再編成が実施されます。新委員会がブロックチェーンのステートを保管し、イベントが生成されれば、移行は完了します（Proof of Commiteeが変更されます）。新委員会への移行が必要になれば即座にシャットダウンプロセスが開始され、現在の委員会が現在までのブロックに同意していることを確認します。シャットダウンブロックが生成され、委員会変更イベントがロールバックされなければ、旧委員会は向こうとなり、新委員会に引き継がれます。

トランザクションの処理速度をさらに上げるために、トランザクションの処理はブロックがプロポーザーから提示された/バリデータに検証された直後に開始されます。図7ではトランザクションがどのように処理されるかのフローを示しています。トランザクションは次のブロックのためにキューされ、FastTrackコンセンサスと並列に実行されます。トランザクションのファイナライズは、ブロックのPoFの成立に依存します。

図7の説明コメント：
- S1.B2(Shard 1, ブロック2)にはTx2, 3が含まれており、プロポーザーにより提出されます
- バリデーターは、Tx2, 3を実行、検証しProof of Verificationを生成し、署名します
- それぞれのPoVを集約して、PoJ(S1, B2)を生成します
- この時、PoF(S1, B1)が成立します
- S1.B3(Shard 1, ブロック3)にはTx4, 5が含まれており、プロポーザーにより提出されます
- バリデーターは、Tx4, 5を実行、検証しProof of Verificationを生成し、署名します
- それぞれのPoVを集約して、PoJ(S1, B3)を生成します
- この時、PoF(S1, B2)が成立します

また、Partisia Blockchainのコンセンサスモデルは様々な方法で高速なトランザクション速度を維持します。
- Sharding（[Sharding](#sharding) で説明します）とeagerブロック生成により、トランザクションの生成からブロック生成までの時間が短縮されます
- トランザクションの即時実行により、トランザクション処理速度が向上します
- FastTrackコンセンサスにより、高速な承認、ファイナライズを可能にします

### Sharding
Partisia Blockchainではshardingを採用し、L1ブロックチェーンサービスとトランザクションスピードの拡張性を確保しています。Shardingにより、処理負荷は _S_ 個の並列Shardに分割されます。コンセンサスモデルに影響を与えないよう、ベイカーノードの総数が1000を超えるまで、全てのベイカーノードは全ての並列シャードを実施することを義務付けています。しかし、コンセンサスモデル（[コンセンサスとブロック生成](#コンセンサスとブロック生成) ）はShardに依存しつつも、Shard自体は独立になっているので、Shardの実施により負荷を分散できます。委員会を保ち、新しい委員会がShardをまたがって運営できるよう、Proof of Commiteeは全てのShard間で変更されます。

スケーラブルなブロック生成は図8,9で示されるように各Shardが[コンセンサスとブロック生成](#コンセンサスとブロック生成) で説明したコンセンサスモデルに従い、ブロックの生成で構成されます。3 Shardを統合したブロックチェーンは、Shardなしのブロックチェーンに比べ3倍平行にトランザクションを処理することが出来ます（線形スケール）。メッセージの伝搬を含むコンセンサスが、Shardごとに独立・並行して実施されています。

ブロックを適切に追跡するため、次のような仕組みを導入し、統合チェーンを考えます：
- ブロック生成時間：タイムスタンプはブロックプロポーザーによりセットされ、同じShardのブロックに対して記載
- Shardブロック数：該当Shardにおけるブロック数
- 統合チェーンブロック数：(Shard数, Shardブロック数, ブロック生成時間)で作られます

図9で記載している、(S1,B1,T1)等がこの記載です。

全てのShardは、ジェネシスで指定されるガバナンスShardを除き同等です（図9より）。ガバナンスShardはPartisia Blockchainのガバナンスについてのタスクを担うこと以外は他と同じです。ガバナンスタスクには、以下のタスクが含まれます：
- 委員会の変更
  - 審査済みのベーカーノードの追加
  - 審査済みのノードの除外
  - 1000ベイカーノードを超えた後、新しい委員会を設立
- 投票の実施
  - ノードの除去・再スタート
  - ガバナンスの更新
- Shard間の設定・接続
  - 有効なShardやルーティング（ルーティングとは何か？）
  - 手数料構造の変更

### L1ブロックチェーンサービスの支払いスキーム
Proof of Workベースのブロックチェーンには様々な欠点がありますが、特性の一つとして、マイナーが取引を検証することに大きなインセンティブがあることが挙げられます。Proof of Workでは、最長のチェーンでないことが判明したチェーンでマイニングを行うことはコストが大きく、報酬に見合わないためです。このため、マイナーはマイニングの前に取引を検証し、最長のチェーンを作成するインセンティブを持ちます。
委員会ベースのコンセンサスでは、トランザクションを実行し署名することでブロックを署名しますが、ここまでには適切に検証を行うためのインセンティブは搭載されていません。

Partisia Blockchainではこの問題（検証にインセンティブ付加）に対してコンセンサスモデル全体の設計で対応しています。まず、PoVは信頼性の高い検証を保証し、一方でPoJ, PoFを含むFastTrackコンセンサスプロトコルとシャットダウンプロセスによって適切な合意形成が保証されています。しかし、P2Pネットワークによりノードが接続し、メッセージが伝搬しなければブロックチェーンは低速化してしまいます。この問題に対処するには、P2Pレイヤーにおいてもインセンティブを導入する必要があります。

このインセンティブスキームでは、L1ブロックチェーンサービスにより得られる総収入 _R_ を分配します。P2PレイヤーにおいてPoVの署名の送信つまり個々のノードの接続性に対しインセンティブを付与することで実装されます。

インセンティブスキームはノードから報酬スマートコントラクトに送信される、公開情報に依存しており、スマートコントラクトが設計に基づいて _R_ を計算し、ベイカーノードの間で分配します。スマートコントラクトに集約された情報はコンセンサスにおいて取得される署名を集約したメタデータであり、実際の署名ではありません。インセンティブの付与は、特定のブロックが生成・確定された後に実施され、コンセンサスやトランザクションの実行を妨げるものではありません。

この設計により、報酬スマートコントラクトは報酬の配布を行いますが、ノードが署名してP2Pネットワークで送信した情報それ自体を保持しているわけではありません。ただ局所的には、ノードはネットワークの情報を保持しており、他のノードに対する情報送信と報酬を通じて、局所的な選択に対してインセンティブを与えます（意味わからないですここ本当に）。図8では、このインセンティブスキームによって、どのように報酬 _R_ が分配され、他のノードから受け取った署名数を報告する方法がどうであるかを示しています（？？？）。

インセンティブスキームについては、図10で示されるように4段階になっています：
- ステップ1: 公開情報の送信：それぞれのノードは他のノードから取得した固有の署名を提出します
- ステップ2: 適格性：ステップ1で送信された情報を基に、全ノードの50%から該当ノードの署名が確認された場合に、ノードは適格となります
- ステップ3: 配布：ステップ2の審査を通過したノードに、等しく _R_ を割当てます
- ステップ4: ステップ3で割り当てられたシェアを、ピアノードが受信し、ステップ2の審査を通過したノードがステップ1で報告した情報に含まれる署名に比例し、分配する（ステップ3で標準額を割り当て、更にステップ4で重みづけを行います）

更に、このインセンティブスキームを進化させるため、チャレンジャーとして、一つのベイカーノードをランダムに選出し、自分の署名ではなく、他人の署名についての伝搬を評価するチャレンジを追加することにしました。

選ばれたチャレンジャーは、チャレンジャーの署名を受信・送信したことを報告したノードに対して自動的にチャレンジを実行します。もし、チャレンジャーの署名を受信・送信したことを報告したが、その証拠（チャレンジャーの署名）を提出できない場合、ステークされたMPCトークンはチャレンジャーに与えられます。

ノードは、意図的により多くの署名を送ったと主張したり、より少ない署名を送ったと主張することが出来ます。まず、誤報自体はノードに対する報酬には直接的な影響を与えませんが、虚偽の報告は検証可能なため、ノードが受送信した署名数を誤って報告した場合、実際に署名の送り先のノードが反応し、他ノードの報酬額に影響が及びます。

正直に報告することがインセンティブ上、最適な戦略であることの説明は、以下の通りです：
1. ノード _j_ が事実より*少ない*署名を報告したとします。この時、報告されなかった署名に関するノードは得る報酬が少なくなり、今後のエポックにおいて、ノードjが正しく署名を送信しなかったことでペナルティを与えられる可能性があります。
2. ノード _j_ が事実より*多い*署名を報告したとします。この時、チャレンジによるコストが発生しうるため、より多い署名の報告はディスインセンティブが働きます。

インセンティブスキームのステップ2, 適格性審査は複数のノードからの情報により構築されるため、より多くのノードにおいて、連携操作が必要になります。ブロックチェーンのトランザクションとコミュニケーションを節約するため、個々のノードが提供するパブリックシグナルは局所レベルで実施され、インセンティブの支払いはブロック間で集約され、ブロックチェーンエポックごとに実施されます。

結論として、このインセンティブスキームによって、正直な署名実績報告にインセンティブが与えられ、接続レベルが高く最も多くの署名を伝搬したノードが報酬を受け取ることになります。

## Zero Knowledge 計算
Partisia Blockchainでは、分散型のゼロ知識(ZK)計算技術によって、プライバシーを保護した状態で計算処理が可能です。

ZK計算とは、計算作業の関係者に対して、ある種のプライバシー特性が保持された状態で実施する計算手法です。より簡単に説明すると、分散型での計算で、依頼者はインプットをZKノードに提供し、ZKノードはインプットに対して計算処理を実施します。ZK計算が良いプライバシー特性を持っており、特殊な点は、この計算手法では、ZKノードは実際に依頼者のインプットが何であったかを明らかにせず計算が可能なことです（全てのZKノードが不正行為を行わない限り）。

このセクションでは、ZK計算の紹介と、Partisia Blockchainでどのように導入されているかを説明します。詳細については、MPC as a Serviceの項に記載されている[Partisia Blockchain yellow paper](https://medium.com/partisia-blockchain/mpc-techniques-series-part-10-mpc-as-a-service-the-partisia-blockchain-infrastructure-9b4833e77965)をご覧ください。

このセクションを通して、ZK計算とMPCという言葉は同一とします。

### プライベートスマートコントラクトの概要
選出されたZKノードは、ZK計算を実施する上で以下の2つの役割を持ちます：
- 前処理（Pre processing）：前処理を行うノード（前処理ノード）は、後で計算ノードが高速に計算処理が出来るよう、特定の暗号学的な処理を行います。
- ZK計算：セキュアな計算を実施するノード（計算ノード）は、前処理ノードにより生成された暗号学的データ（前処理データ）を利用し計算を行います。

ZK計算を実施するには、公開情報を使用した通常の計算と比較して、大きな同期作業が必要となります。簡単に言えば、ZK計算は複数のZKノードをまたがって実施され、前処理を実施するZKノードのグループから前処理データを受信し、計算ノードが計算を実施します。これらのノードの選択は、ZK計算サービスを購入した依頼者が定める要件に従って行われます。MPCのセキュリティモデルでは、_t_ 個以上のノードが不正行為を行わない限り、プライバシーが保たれます。つまり、依頼者は、 _t_ 個以上のノードの不正行為は同時に成立しないと仮定できるような閾値 _t_ を決める必要があります。保証ステーキング、依頼者がZKノードを選択するトラスト市場など、このような不正行為に対抗するための、多くの機能が今後導入される予定です。

### MPCオーケストレーション
ZK計算を実施するためには、前処理ノードとZK計算ノードを選出する必要があります（複数）。選択の閾値は依頼者により指定されますが、オーケストレーション自体はPartisia Blockchain上で処理されます。

前処理、計算処理を問わず、全てのZKノードはグループとして扱われます。ZKノードは審査を通過し、リストは公開されており、サーバーの位置情報やスコア（後ほど説明します）などの情報があります。依頼者は、閾値 _t_ 、プロトコルの種類、実行する計算処理などのパラメータを指定します。その後、Partisia Blockchainでは、ZKノードのプールから適切なノードの集合を選出する計算処理を実施されます。この"購入イベント"は計算処理を実施するチェーン上に送信されます。図11では、ZK計算もしくはMPC as a Serviceとしてのオーケストレーションを図示しています。

図11のコメント：
- ZKノードのグループから、計算ノード(ZK Node)、前処理ノード(Preprocessor)が指定される（下部分）
- 実際に処理を実施（Execution）し、Resultを提出する

### 前処理(Pre processing)
ほとんどのZK計算処理の開始前に、前処理として特定の暗号学的処理を行います。処理の種類、負荷は要求される計算内容によってまったく異なり、大まかに言えば、計算処理が複雑であればあるほど、前処理の処理負荷は大きくなります。

前処理データの生成は前処理ノードにより行われます。前処理ノードも計算ノードと同時に選出され、前処理を行います。汎用前処理データは高速なZK計算のために利用できます。事前に計画されていたZK計算の場合は、ZK計算のスケジュール時に前処理が実施されます。

### 支払いスキーム
ZK計算において、計算ノード・前処理ノードはセキュアな計算処理を行うことで報酬を得ます。各ノードの受け取る報酬は、計算の複雑さ（例えば、計算処理に含まれる掛け算数など）や各ノードのスコア等、様々な要因に依存します。

参加するZKノードへの支払いは、ユーザーもしくは計算処理の依頼を行ったエンティティの両方により行われます。

### スコアリング
Partisia Blockchainでは、全てのZKノードに対して、スコアリング機構があります。ノードのスコアは、ノードがどれだけの正しい計算を処理したか等、多くの要因に依存します。

### ステーキング
不正行為に対するディスインセンティブとして、計算ノード・前処理ノードは、MPCトークンの保証ステーキングが必要となります。この機構により、不正行為を行おうとしたノードの保証ステーキングにより預けられたMPCトークンは没収されます。

このステーキング処理は、ZKノードの管理する秘密計算のプライバシーを保証するためのオプションです。秘密計算情報の価値を本当に理解しているのは、Partisia Blockchain上で動作するサービスやその利用者のみであり、この情報の非対称問題に対応するため、ユーザーは適切な保険として保証ステーキング額を設定できます。

明確な不正行為が判明した場合、保証ステーキングにより預けられたMPCトークンはロックされ、ノード運営者は一時的に審査ステータスが取り消されます。ロックされたMPCトークンは、分散型disputeシステムにより管理されます。

## オラクルサービス
このセクションでは、異なるブロックチェーン間やプラットフォーム間で価値、データを移動できるインターオペラビリティを提供する、オラクルサービスについて説明します。オラクルサービスには、BYOCやトークンブリッジのような統合サービスも含まれ、審査済みのオラクルノードの集合により提供されます。

### クロスチェーンセキュリティモデル
実際のセキュリティはエコノミーモデルと暗号学的な機能によって提供されます。オラクルノードは保証ステーキングにより保証機能を提供し、一方暗号学的な機能により不正行為が抑制されます（全然わかんないです）。

一般的な構成は図12に示されています。単一エポック内において、オラクルノードの一部で構成した集合がスモールオラクルと呼ばれ、オラクルにより提供される値に対して保証ステーキングを実施します。各エポックの完了後、全てのベイカーノード、ブロックチェーン全体から構成されるラージオラクルは、最新のエポックにおいてのスモールオラクルによるリスク管理が実施されたことを保証します（どういう意味？？？）。
これは次の2つの方法のどちらかで達成されます：
- ラージオラクルはスモールオラクルの変更に利用した秘密鍵とスモールオラクルの使用した公開鍵を保有します
- ブロックチェーン全体のファイナライズ証明がステートを維持し、次のスモールオラクルを指定します

（ここまったく意味わからなくて草）

[Bring Your Own Coin (BYOC)](#bring-your-own-coin-byoc), [トークンブリッジ](#トークンブリッジ) において、BYOC, トークンブリッジのために設計されたステーキング機構及びdispute機構について説明します。

図12のコメント：
- エポックの終了時、ブロックチェーン全体でエポックごとファイナライズを確定するか、ラージオラクルによりエポックごとに検証して次のスモールオラクルを割り当てるということか。

ラージオラクルもしくは、ファイナライズ証明によって、図12に示されるようにエポックの決済処理とリスクの累積を避けることが出来ます（エポックごとにリスクを処理しきるため）。このアプローチを取る際に、次のような運用上のトレードオフが発生します：
- ラージオラクルはPartisia Blockchain上での作業が発生するが、この作業は他ブロックチェーンに影響しません
- ファイナライズ証明はPartisia Blockchain上での作業は少ないが、他ブロックチェーンにデータを記録させる必要があり、コストがかかる可能性があります

この二つのアプローチの性質により、他のブロックチェーンにおいてファイナライズ証明を記録させるコストが高額な場合、ラージオラクルのほうがコスト効率が良いかもしれませんし、その逆にもなりえます。そのため、Partisia Blockchainでは両方の運用を可能にすることで、コスト効率を最大で運用することが出来ます。

ラージオラクルは閾値署名（これは何か？？）をセキュアに計算するMPCプロトコルを適用します。ラージオラクルは最大1000ノードで運用され、ファイナライズ証明で提供されるセキュリティと同等のセキュリティを提供します。

閾値署名が何かいまいちわからないのでセキュリティにどう影響するかよくわかんないです・・・・（コメント）

スモールオラクルの役割は、トランザクションの承認・署名とステーキング機構による保証ステーキングを実施することです。ここについては、[クロスチェーンセキュリティモデル](#クロスチェーンセキュリティモデル), [Bring Your Own Coin (BYOC)](#bring-your-own-coin-byoc) で説明します。

結論として、スモールオラクルのノードには保証ステーキングに基づいた効率的な運用を可能とし、ラージオラクルもしくはファイナライズ証明によって、Partisia Blockchain上で最高レベルのセキュリティを提供します。

コメント
※エポックを区切ることで、ラージオラクルかファイナライズ証明を切り替えられるようにした。あるエポックではラージオラクルによる検証（この検証を閾値署名の計算を実施するMPCプロトコルと言っているのだろうが・・・）、他のエポックではファイナライズ証明を実施する（他のチェーンの出口を検証するか、Partisia Blockchainの入口を検証するかの違い？どちらか一方を検証すれば十分だろ？ということだろう）。

### Bring Your Own Coin (BYOC)
Bring Your Own Coin (BYOCと呼びます)によって、Partisia Blockchain上での手数料支払い手段として外部ブロックチェーンのコイン・トークンを持ち込み、ノード運営者への支払いが可能になります。BYOCは、他のブロックチェーンのコイン・トークンの利用を促進しながら、ブロックチェーン間でのプライバシー・インターオペラビリティを提供するPartisia Blockchainの役割を支えるコア機能です。

図13では、Partisia Blockchain上のBYOCスマートコントラクトが、複数のBYOCの相手として導入されたチェーンのスマートコントラクト（ここではEthereum）を調整する構成を示しています。

クロスチェーンウォレットの秘密状態を維持するためには、両方のチェーン（Partisia Blockchain, Ethereum）のスマートコントラクトの状態を監視し、処理する必要があります。処理するのはクロスチェーンウォレット*への*資金移動及びクロスチェーンウォレット*からの*資金移動です。スモールオラクルのノードはトランザクションに対して保証ステーキング及び署名を行います。

全てのトランザクションは、スモールオラクルの過半数の承認を得た後に実行されます。つまり、全ての不正行為はスモールオラクルの過半数によって実施されます。

[ステーキング](#ステーキング-2) で説明するステーキング機構及びdispute機構はこの構造を利用しステークされたMPCトークンがBYOCオラクルのユーザーに対する保証として活用します。

Ethereumを例にして、BYOCがエポックを超えてどのように動作するかを示しています：
エポック _N-1_ において：
- _n_ 個のオラクルノードで構成されたスモールオラクルが稼働しており、金銭的閾値 _T_ をこのエポックでスモールオラクルが管理できる最大金額とします。ここで _T_ は、_n_ 個のノードによって提供される保証ステークの最小金額　×　想定されるトランザクション数（1つのdisputeを実行するためのコストに見合うくらい、また最小トランザクションサイズにより推定可能）で決まります。
- 初期状態においては、全てのオラクルノードが同じ保証ステークの最小金額をロックします。

エポック _N_ において：
- ユーザーが ETH を BYOCします：
  - ステップ1: ユーザーが ETH を BYOCスマートコントラクトに送信します
  - ステップ2: このETHの送信により、ETHとETH BYOC TwinsをEthereum/Partisia Blockchainのコントラクトで一致させる検証処理が開始され、このトランザクションはスモールオラクルの過半数に承認された後、Partisia Blockchain上にトランザクションとして処理されます
  - ステップ3: Partisia Blockchain上でETH BYOC Twinsがユーザーアカウントに生成されます
- ユーザーがETH BYOC TwinsをPartisia Blockchain上で消費します：
  - ステップ1: ユーザーはETH BYOC Twinsを消費してPartisia Blockchain上でトランザクションを作成します。BYOC Twinsは特定のスマートコントラクトに送付され、pending状態として支払い用コントラクトにロックされます
  - ステップ2: スマートコントラクトはETH BYOC Twinsを消費しトランザクションを実行し、pending状態の手数料に実行済みラベルを付与します
  - ステップ3: 特定の時間間隔（毎時 or 毎日）で、全てのpending手数料はノードに実際のコストに対応して分配され、残りはスマートコントラクトに戻ります
  - ステップ4: 個々のノード運営者はETHをEthereumチェーン上で引き出せるようになります

次のエポックの用意として：
- スマートコントラクトは[クロスチェーンセキュリティモデル](#クロスチェーンセキュリティモデル) に記載したように、新しいスモールオラクルを選出します

エポックの終了：
- スモールオラクルで管理されている価値が閾値 _T_ に達するとエポックが完了します。つまり、_T_ によってエポック長が決まります（固定値ではない・・・・？）。

エポック _N+1_ において：
- 次のスモールオラクルは、直前のスモールオラクルのBYOCを引継ぎ、上の手続きを継続します

エポック中もしくはエポックの終了後24時間まで、Partisia Blockchainにアカウントを保有するユーザーの誰もがdisputeプロセスを開始できます。このステーキング機構により、BYOCオラクル自体は現在のdisputeに関係なく動作することが可能です。

#### ステーキング
これまで記載したように、スモールオラクルのノードは担保としてMPCトークンをロックします。このロックされたMPCトークンはユーザーへの補償として利用されるため、この上限として解釈すれば、トラストの尺度は明確です。このサブセクションでは、明確な不正行為が発生した場合の対応を説明します。

リスクの累積を避けるには、リスクを1エポックで完結させる必要があります。この完結手法を見るために、以下の2つの理由のため、スモールオラクルが完全に信頼できます：
1. BYOCのユーザーは、スモールオラクルのノードの過半数の不正・承認が無ければ不正行為が出来ません
2. エポックの終了時に、Partisia Blockchain上のBYOC Twinsと統合されたチェーン（Ethereumなど）のトークンの不均衡を確認するのは簡単です

不正行為には次のような2タイプがあります：
1. Type 1: Partisia Blockchainにおいて、どのユーザーが不正行為による被害を受けたかが判明しており、不足するBYOC Twinsの価値がPartisia Blockchain上で管理できる範囲内に収まっています
2. Type 2: Partisia Blockchainにおいて、どのユーザーが不正行為による被害を受けたかが判明しておらず、不足するBYOC Twinsの価値がPartisia Blockchain上で管理できる範囲内に収まっていません

この2種類の不正行為の例を考えるために、Ethereum ベースのBYOCを考えます。

Type 1の不正行為：
- ユーザーはEthereumチェーン上で、10 ETHをBYOC コントラクトに送付します。スモールオラクルは送金トランザクションを検出しましたが、1 ETHとして検出しました。そのため、ユーザーはPartisia Blockchain上で1 ETH BYOC Twinsのみを取得し、9 ETH BYOC Twinsが失われました
  - 解決策：dispute解決時、残りの9ETH BYOC Twinsが生成され、該当のトランザクションに署名したスモールオラクルのメンバーに対してペナルティを科します

- ユーザーはPartisia Blockchain上で、10 ETH BYOC Twins をBYOCコントラクト経由でEthereumチェーンへ引き出します。スモールオラクルは5 ETHのみをEthereumチェーンでユーザーに送信し、5 ETHが失われました
  - 解決策：dispute解決時、失われた5 ETHがユーザーに送付され、該当のトランザクションに署名したスモールオラクルに対してペナルティを科します

疑問：複数のエポックで同時に不正行為が発生した場合、補償金が足りない事態が発生しないのか？（というか補償金のためにUSD建てでステーキングが必要なんですね）

Type 2の不正行為：
- ユーザーからの操作なしに、スモールオラクルは10 ETHの引き出しトランザクションを発行・署名しEthereumチェーン上のBYOCコントラクトから引き出しました
  - 解決策：dispute解決時、スモールオラクルの保証ステークによりロックしたMPCトークンを使用します（後で記載します）

- ユーザーはEthereumチェーン上で、10 ETHをBYOC コントラクトに送付します。スモールオラクルは送金トランザクションを検出しましたが、20 ETHとして検出しました。そのため、ユーザーはPartisia Blockchain上で20 ETH BYOC Twinsを取得し、BYOC Twinsは1:1でのペッグから外れてしまいました
  - 解決策：dispute解決時、スモールオラクルの保証ステークによりロックしたMPCトークンを使用します（後で記載します）

重大な不正行為はType 2の不正行為で、保証ステークが重要な役割となります。1つめの解決策は、Partisia Blockchainで没収した補償ステークされたMPCトークンを直接市場でETHに変換することです。2つめの解決策は、Partisia BlockchainのユーザーがBYOCまたはETHをMPCトークンに内部市場で変換することです。1つめの解決策では、MPCトークンとETHを交換する流動性の高い市場が必要となり、時間をかけて確立される予定です。

ここで、ステーキングに対するdisputeプロセスの記載が可能となります：
- disputeの開始：
  - disputeは単一のトランザクションに対して1度しか実施できません
  - disputeはPartisia Blockchainにアカウントを持つユーザーならチャレンジャーとして開始出来ます。不正行為の影響を潜在的に受けるユーザー、例えば次のスモールオラクルのメンバー（潜在的不正行為を引き継ぐため）に強いインセンティブがあります
  - チャレンジャーはdisputeコントラクトに支払いを行います。この支払いは、問題が生じない限り、disputeの終了までに払い戻されます
  - チャレンジャーはMPCトークンをデポジットし、disputeを開始します。デポジットは、不正行為が存在した場合、dispute終了までに払い戻されます（そうでなければバーンされます）
- ステークされたMPCをロック：
  - 該当するエポックにおいて、該当するBYOCに割り当てられたステークはスモールオラクルが存在する限りロックされます
- disputeの解決：
  - disputeの解決は、disputeスマートコントラクトにより処理されます
  - Type 1の不正においては、分散型ガバナンスにより直接解決されます
    - 影響を受けたユーザーと賠償金が登録されます
    - スモールオラクルへのペナルティが登録されます
  - Type 2の不正においては、MPCトークンからBYOC Twinsのペッグトークン（ETH等）への変換が開始されます
    - プライマリ、セカンダリマーケットで処理されます
    - disputeはトランザクションごとに実行されますが、マーケットでの処理はまとめて実施することが出来ます。
  - disputeの結果は公開されます
- 補償：
  - Type 1の不正行為：
    - disputeは直接実施されます
    - ユーザーの残高は復旧されます
    - スモールオラクルへのペナルティは、該当トランザクションに署名したノードに均等に割り当てられます
  - Type 2の不正行為：
    - マーケットで処理します
    - 交換された保証ステークの総額は、該当トランザクションに署名したノードに均等に割り当てられます
    - コントラクトの残高不均衡が復旧されます

ここで、不正行為に関するdisputeは単一トランザクションごとに実施され、それぞれのdisputeがType 1, Type 2に分類されることに注意ください。

ステーキング、disputeのメカニズムと別で、アップタイム不足により、ステークされたMPCトークンが少額バーンされます。

### トークンブリッジ
トークンブリッジは、独立した2つのトークンとブロックチェーンの間でトークン（価値）をシームレスに移転することを可能にします。BYOCと同様に、蓄積されるリスクはエポックごとに分離して対処されます。このデザインは、2つのBYOCオラクルを組み合わせたものとして解釈できます。図14で、トークンブリッジの設計を示しています。

EOSとEthereumのトークンブリッジを考えます。ここではEOSトークンがEOSブロックチェーンでロックされ、ERC-20版のEOSトークンがEthereumチェーンで発行されることを考えます。トークンブリッジはこのプロセスを保護・運用します。エポックごとにプロセスを見ていきましょう：

エポック _N-1_ ：
- _n_ 個のオラクルノードで構成されたスモールオラクルが稼働しており、 金銭的閾値 _T_ をこのエポックでスモールオラクルが管理できる最大金額とします。_T_ は、 _n_ 個のノードにより提供される保証ステークの最小金額　×　想定されるトランザクション数（1つのdisputeを実行するためのコストに見合うくらい、また最小トランザクションサイズにより推定可能）で決まります
- 初期状態においては、全てのオラクルノードが同じ保証ステークの最小金額をロックします
- スモールオラクルはEOS/Ethereumチェーンにおいてスマートコントラクトをデプロイします

エポック _N_ ：
- ユーザーがEOSをETHチェーンにブリッジします：
  - ステップ1: ユーザーがEOSをブリッジスマートコントラクト(EOS上)に送信します
  - ステップ2: このEOSの送信により、EOSとERC-20-EOSをEOS/Ethereumのコントラクトで一致させる検証処理が開始され、このトランザクションはスモールオラクルの過半数に承認された後、Partisia Blockchain上にトランザクションとして処理されます
- ユーザーがERC-20-EOSをEthereumチェーン上で消費します：
  - ERC-20-EOSはEthereumチェーン上で自由に利用できます
- ユーザーがERC-20-EOSをEOSチェーンにブリッジします：
  - ステップ1: ユーザーがERC-20-EOSをブリッジスマートコントラクト(Ethereum上）に送信します
  - ステップ2: このERC-20-EOSの送信により、ERC-20-EOSとEOSをEthereum/EOSのコントラクトで一致させる検証処理が開始され、このトランザクションはスモールオラクルの過半数に承認された後、Partisia Blockchain上にトランザクションとして処理されます
  - ステップ3: ERC-20-EOSはバーンされ、ロックされたEOSトークンはEOSチェーン上の特定のウォレットで利用できます

エポック _N+1_ の用意として：
- スマートコントラクトは[クロスチェーンセキュリティモデル](#クロスチェーンセキュリティモデル) で記載したように新しいスモールオラクルを選出します

エポック _N_ の終了：
- スモールオラクルで管理されている価値が閾値 _T_ に達するとエポックが完了します。つまり、_T_ によってエポック長が決まります（固定値ではない・・・・？）。

エポック _N+1_ において：
- 次のスモールオラクルは、直前のスモールオラクルのBYOCを引継ぎ、上の手続きを継続します

#### ステーキング
これまで記載したように、スモールオラクルのノードは担保としてMPCトークンをロックします。このロックされたMPCトークンはユーザーへの補償として利用されるため、この上限として解釈すれば、トラストの尺度は明確です。このサブセクションでは、明確な不正行為が発生した場合の対応を説明します。

リスクの累積を避けるには、リスクを1エポックで完結させる必要があります。この完結手法を見るために、以下の2つの理由のため、スモールオラクルが完全に信頼できます：
1. トークンブリッジのユーザーは、スモールオラクルのノードの過半数の不正・承認が無ければ不正行為が出来ません
2. エポックの終了時に、EOSチェーン上にロックされたEOSトークンと、Ethereumチェーン上に存在するERC-20-EOSトークンの不均衡を確認するのは簡単です

不正行為には次のような2タイプがあります：
1. Type 1: Partisia Blockchainにおいて、どのユーザーが不正行為による被害を受けたかが判明しており、不足する価値がPartisia Blockchain上で管理できる範囲内に収まっています
2. Type 2: Partisia Blockchainにおいて、どのユーザーが不正行為による被害を受けたかが判明しておらず、不足する価値がPartisia Blockchain上で管理できる範囲内に収まっていません

この2種類の不正行為の例を考えるために、EOSからEthereumチェーンへのトークンブリッジを考えます。

Type 1の不正行為：
- ユーザーはEOSチェーン上で、10 EOSをEOSコントラクトに送付します。スモールオラクルは送金トランザクションを検出しましたが、1 EOSとして検出しました。そのため、ユーザーはEthereumチェーン上で1 ERC-20-EOSのみを取得し、9 ERC-20-EOSが失われました
  - 解決策：dispute解決時、残りの9 ERC-20-EOSが生成され、該当のトランザクションに署名したスモールオラクルのメンバーに対してペナルティを科します

- ユーザーはEthereumチェーン上で、10 ERC-20-EOSをETHコントラクト経由でEOSチェーンへ引き出します。スモールオラクルは5 EOSのみをEOSチェーンでユーザーに送信し、5 EOSが失われました
  - 解決策：dispute解決時、失われた5 EOSがユーザーに送付され、該当のトランザクションに署名したスモールオラクルに対してペナルティを科します

Type 2の不正行為：
- ユーザーからの操作なしに、スモールオラクルは10 ERC-20-EOSの引き出しトランザクションをETHチェーン上で発行・署名しEthereumチェーン上のブリッジコントラクトから引き出しました
  - 解決策：dispute解決時、スモールオラクルの保証ステークによりロックしたMPCトークンを使用します（後で記載します）

- ユーザーはEthereumチェーン上で、10 ERC-20-EOSをブリッジコントラクトに送付します。スモールオラクルは送金トランザクションを検出しましたが、20 ERC-20-EOSとして検出しました。そのため、ユーザーはEOSチェーン上で20 EOSを取得し、ERC-20-EOSとEOSは1:1でのペッグから外れてしまいました
  - 解決策：dispute解決時、スモールオラクルの保証ステークによりロックしたMPCトークンを使用します（後で記載します）

疑問：複数のエポックで同時に不正行為が発生した場合、補償金が足りない事態が発生しないのか？（というか補償金のためにUSD建てでステーキングが必要なんですね）

重大な不正行為はType 2の不正行為で、保証ステークが重要な役割となります。1つめの解決策は、Partisia Blockchainで没収した補償ステークされたMPCトークンを直接市場でETH/EOSに変換することです。2つめの解決策は、Partisia BlockchainのユーザーがBYOCまたはETH/EOSをMPCトークンに内部市場で変換することです。1つめの解決策では、MPCトークンとETH/EOSを交換する流動性の高い市場が必要となり、時間をかけて確立される予定です。

ここで、ステーキングに対するdisputeプロセスの記載が可能となります：
- disputeの開始：
  - disputeは単一のトランザクションに対して1度しか実施できません
  - disputeはPartisia Blockchainにアカウントを持つユーザーならチャレンジャーとして開始出来ます。不正行為の影響を潜在的に受けるユーザー、例えば次のスモールオラクルのメンバー（潜在的不正行為を引き継ぐため）に強いインセンティブがあります
  - チャレンジャーはdisputeコントラクトに支払いを行います。この支払いは、問題が生じない限り、disputeの終了までに払い戻されます
  - チャレンジャーはMPCトークンをデポジットし、disputeを開始します。デポジットは、不正行為が存在した場合、dispute終了までに払い戻されます（そうでなければバーンされます）
- ステークされたMPCをロック：
  - 該当するエポックにおいて、該当するBYOCに割り当てられたステークはスモールオラクルが存在する限りロックされます
- disputeの解決：
  - disputeの解決は、disputeスマートコントラクトにより処理されます
  - Type 1の不正においては、分散型ガバナンスにより直接解決されます
    - 影響を受けたユーザーと賠償金が登録されます
    - スモールオラクルへのペナルティが登録されます
  - Type 2の不正においては、MPCトークンからトークンブリッジで扱ったトークンETH/EOSへの変換が開始されます
    - プライマリ、セカンダリマーケットで処理されます
    - disputeはトランザクションごとに実行されますが、マーケットでの処理はまとめて実施することが出来ます。
  - disputeの結果は公開されます
- 補償：
  - Type 1の不正行為：
    - disputeは直接実施されます
    - ユーザーの残高は復旧されます
    - スモールオラクルへのペナルティは、該当トランザクションに署名したノードに均等に割り当てられます
  - Type 2の不正行為：
    - マーケットで処理します
    - 交換された保証ステークの総額は、該当トランザクションに署名したノードに均等に割り当てられます
    - コントラクトの残高不均衡が復旧されます

ここで、不正行為に関するdisputeは単一トランザクションごとに実施され、それぞれのdisputeがType 1, Type 2に分類されることに注意ください。

## 記法及び定義について
このセクションでは、イエローペーパーで使用される表記法とその定義を説明します。

Partisia Blockchainにおける時間に関する単語の定義：
- ブロック生成時刻：ブロックプロポーザーにより設定される可読性の高いタイムスタンプで、同じshardの前ブロックよりも後にしなければなりません（最小単位は+1ms)
- Shardブロック数：特定のShardにおいて、ジェネシスから現在までのブロック数です
- 統合チェーンブロック数：Shard数、Shardブロック数とブロック生成時刻を併せて、S1.B1.T1などのように記載します
- シャットダウン：指定されたブロックから30秒の停止状態（そういう意味なんですか・・・？）
- オラクルサービスのエポック：オラクルサービスによって保持される値で、動的に変動します
- L1ブロックチェーンのエポック：ノードに手数料の支払い期間を締め切る区間です

基本的な表記法：
- リーダーノード：P2Pレイヤーにのみ参加する、ブロックチェーンデータの読み取りノードです
- ベイカーノード：コンセンサスレイヤーに参加する、審査済みのノードです
- ZKノード：ゼロ知識計算サービス提供に参加する、審査済みのノードです
- オラクルノード：オラクルサービス提供に参加する、審査済みのノードです
- _L_ は審査済みのリーダーノードの集合です（そんなものあるんですか）
- _M_ は審査済みのベイカーノードの集合です
- 委員会は、審査済みの _M_ 個のベイカーノードで構成されます。_M > 1000_ の場合、1000個のランダムなベイカーノードから構成されます
- 委員会は、各Shardにおいて、プロポーザーを選出しブロックを生成させます
- _n_ はZK/オラクルタスクを実施するために選出されたZK/オラクルノード数です
- MPCが動作するオラクルには、_t_ の閾値を持つセキュリティモデルが実装されています。_t_ 個のノードまでMPCオラクルの持つ情報を取り出すことが出来ません（説明がへたくそです）
- イベントトランザクション：他のトランザクションに誘発して実行されるトランザクションです
